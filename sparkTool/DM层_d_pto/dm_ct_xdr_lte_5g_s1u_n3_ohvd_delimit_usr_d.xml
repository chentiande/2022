<AggrSqlConfig topicId="dm_ct_xdr_lte_5g_s1u_n3_ohvd_delimit_usr_d" period="1d"
               desc="大区/用户-4/5G话单-OTHER/HTTP/VIDEO/DNS/S1MME-单用户定界定段(1天)">
      <functions>
	  </functions>

    <tempTables>
	 <tableName>tmp_dm_ct_xdr_lte_5g_s1u</tableName>
<sql>
<![CDATA[select 

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
0 as abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
0 as total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
0 as abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
0 as total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_s1u_s1mme_mmeusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select

,
"",
00:00:00,
23:59:59,
00:00:00~2020,
abnormal_record_num,
0 as chkhand_bad,
0 as chkhand_good,
concat,
0 as abnormal_record_rate,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
0 as http_dns_reply_delaybad,
0 as http_dns_reply_delaygood,
0 as imei_pei_i_os,
0 as imei_pei_model_name,
0 as imei_pei_term_type,
0 as imei_pei_vendor_name,
msisdn,
or,
0 as pageopen_delaybad,
0 as pageopen_delaygood,
province_id,
province_name,
0 as rtt_dl_termeral_bat,
0 as rtt_dl_termeral_good,
0 as rtt_ul_server_bat,
0 as rtt_ul_server_good,
starttime,
0 as term_change_flag,
0 as term_change_time,
0 as term_service_perceive_good_rat,
0 as termusr_beat_rate,
total_record_num,
0 as usr_service_perceive_good_rat,
0 as video_avgspeed_bad,
0 as video_avgspeed_good,
例原话单为2020,
开始时间为2020,
dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 union all
 select
0 as 
,
0 as "",
00:00:00,
23:59:59,
00:00:00~2020,
abnormal_record_num,
chkhand_bad,
chkhand_good,
0 as concat,
abnormal_record_rate,
0 as dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num,
0 as dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num,
0 as dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num,
0 as dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num,
http_dns_reply_delaybad,
http_dns_reply_delaygood,
imei_pei_i_os,
imei_pei_model_name,
imei_pei_term_type,
imei_pei_vendor_name,
msisdn,
0 as or,
pageopen_delaybad,
pageopen_delaygood,
province_id,
province_name,
rtt_dl_termeral_bat,
rtt_dl_termeral_good,
rtt_ul_server_bat,
rtt_ul_server_good,
starttime,
term_change_flag,
term_change_time,
term_service_perceive_good_rat,
termusr_beat_rate,
total_record_num,
usr_service_perceive_good_rat,
video_avgspeed_bad,
video_avgspeed_good,
例原话单为2020,
开始时间为2020,
0 as dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num
 from ${source_db}.dm_ct_xdr_lte_5g_s1u_n3_ohvd_usr_
where p_date>='${p_date_start}' and p_date<'${p_date_end}'
 	]]>
		</sql>
    </tempTables>

    <resultTables>
	        <resultTable>
	<sql>
		<![CDATA[
			insert overwrite table ${result_db}.dm_ct_xdr_lte_5g_s1u_n3_ohvd_delimit_usr_d partition(p_date='${p_date}')
		
 select substr('${p_start_time}',1,8) as starttime,
max(province_id) as province_id,
max(province_name) as province_name,
msisdn as msisdn,
max(imei_pei_vendor_name) as term_vendor_name,
max(imei_pei_model_name) as term_model_name,
max(imei_pei_i_os) as term_i_os,
max(imei_pei_term_type) as term_type,
case when sum(dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num)>=0.3 or sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num)>=0.3  then 1 else 0 end as sgwusr_mme_abnormal_flag,
case when sum(abnormal_record_num)/sum(total_record_num)>=0.35 then 1 else 0 end as spipusr_abnormal_flag,
case when sum(abnormal_record_num)/sum(total_record_num)>=0.35 then 1 else 0 end as ipranausr_abnormal_flag,
case when sum(abnormal_record_num)/sum(total_record_num)>=0.3 then 1 else 0 end as dnsusr_abnormal_flag,
case when sum(abnormal_record_num)/sum(total_record_num)>=0.3 then 1 else 0 end as celkqiusr_abnormal_flag,
case when sum(abnormal_record_num)/sum(total_record_num)>=0.4 then 1 else 0 end as termusr_abnormal_flag,
total_record_num as usr_total_record_num,
abnormal_record_num as usr_abnormal_record_num,
abnormal_record_rate as usr_abnormal_record_rate,
rtt_ul_server_bat as usr_ul_rtt_delay_abnormal_num,
(case when nvl(rtt_ul_server_good+rtt_ul_server_bat,0)>0 then (nvl(rtt_ul_server_bat,0))/(nvl(rtt_ul_server_good+rtt_ul_server_bat,0)) else 0 end) as usr_ul_rtt_delay_abnormal_rate,
rtt_dl_termeral_bat as usr_dl_rtt_delay_abnormal_num,
(case when nvl(rtt_dl_termeral_good+rtt_dl_termeral_bat,0)>0 then (nvl(rtt_dl_termeral_bat,0))/(nvl(rtt_dl_termeral_good+rtt_dl_termeral_bat,0)) else 0 end) as usr_dl_rtt_delay_abnormal_rate,
pageopen_delaybad as usr_webpage_delay_abnormal_num,
(case when nvl(pageopen_delaygood+pageopen_delaybad,0)>0 then (nvl(pageopen_delaybad,0))/(nvl(pageopen_delaygood+pageopen_delaybad,0)) else 0 end) as usr_webpage_delay_abnormal_rate,
video_avgspeed_bad as usr_video_download_abnormal_num,
(case when nvl(video_avgspeed_good+video_avgspeed_bad,0)>0 then (nvl(video_avgspeed_bad,0))/(nvl(video_avgspeed_good+video_avgspeed_bad,0)) else 0 end) as usr_video_download_abnormal_rate,
chkhand_bad as usr_game_chkhand_abnormal_num,
(case when nvl(chkhand_good+chkhand_bad,0)>0 then (nvl(chkhand_bad,0))/(nvl(chkhand_good+chkhand_bad,0)) else 0 end) as usr_game_chkhand_abnormal_rate,
http_dns_reply_delaybad as usr_reply_delay_abnormal_num,
(case when nvl(http_dns_reply_delaygood+http_dns_reply_delaybad,0)>0 then (nvl(http_dns_reply_delaybad,0))/(nvl(http_dns_reply_delaygood+http_dns_reply_delaybad,0)) else 0 end) as usr_reply_delay_abnormal_rate,
term_service_perceive_good_rat as term_good_rate,
usr_service_perceive_good_rat as termusr_good_rate,
termusr_beat_rate as termusr_beat_rate,
term_change_flag as term_change_flag,
term_change_time as term_change_time,
concat((case when sum(dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num)>=0.3 or sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num)>=0.3  then 1 else 0 end), "","",
(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num)>=0.35 then 2 else 0 end), "","",(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num)>=0.35 then 3 else 0 end), "","",
(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num)>=0.4 then 4 else 0 end), "","",(case when sum(dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num)>=0.3 then 5 else 0 end), "","",
(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num)>=0.3 then 6 else 0 end)) as delimitation_conclusion,
concat((case when sum(dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_s1u_s1mme_mmeusr_d.total_record_num)>=0.3 or sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d.total_record_num)>=0.3  then 1 else 0 end), "","",
(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d.total_record_num)>=0.35 then 2 else 0 end), "","",(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d.total_record_num)>=0.35 then 3 else 0 end), "","",
(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d.total_record_num)>=0.4 then 4 else 0 end), "","",(case when sum(dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_dns_delimitusr_d.total_record_num)>=0.3 then 5 else 0 end), "","",
(case when sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.abnormal_record_num)/sum(dw_ct_xdr_lte_5g_s1u_n3_ohv_celkqiusr_d.total_record_num)>=0.3 then 6 else 0 end)) as treatment_suggestion
from 
(select * from tmp_dm_ct_xdr_lte_5g_s1u 
) t1 
 inner join (select distinct eci,ne_type from dim_ne_ec where ne_type='EUTRANCELL') t3 on t_cell.nci_eci=t3.eci)   tt3
 on tt1.msisdn=tt3.msisdn and tt1.starttime=tt3.starttime
left join (dw_ct_xdr_lte_5g_s1u_n3_ohv_ipranusr_d) tt4 on tt1.msisdn=tt4.msisdn and tt1.starttime=tt4.starttime
left join (dw_ct_xdr_lte_5g_s1u_n3_ohv_sgwusr_d t1) tt5 on tt1.msisdn=tt5.msisdn and tt1.starttime=tt5.starttime
left join (dw_ct_xdr_lte_5g_s1u_n3_ohv_spipusr_d) tt6 on tt1.msisdn=tt6.msisdn and tt1.starttime=tt6.starttime
left join (dw_ct_xdr_lte_5g_s1u_n3_ohv_termusr_d) tt7 on tt1.msisdn=tt7.msisdn and tt1.starttime=tt7.starttime
left join (dm_ct_xdr_lte_5g_s1u_n3_ohvd_usr_d) tt8 on tt1.msisdn=tt8.msisdn and tt1.starttime=tt8.starttime)

						  ]]>
            </sql>
        </resultTable>
	</resultTables>
	</AggrSqlConfig>